<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Callback</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<p>ログイン処理中…</p>

<script>
const CLIENT_ID = "1vltl309a8prhlk9drhc0ofnff";
const REDIRECT_URI = "https://d3hhstjr0rx2o4.cloudfront.net/callback.html";
const COGNITO_DOMAIN = "https://ap-northeast-1fpwxyhi1o.auth.ap-northeast-1.amazoncognito.com";

async function exchangeToken(code) {
    const codeVerifier = localStorage.getItem("pkce_verifier");

    const body =
        "grant_type=authorization_code" +
        "&client_id=" + CLIENT_ID +
        "&code=" + code +
        "&redirect_uri=" + encodeURIComponent(REDIRECT_URI) +
        "&code_verifier=" + codeVerifier;

    const res = await fetch(COGNITO_DOMAIN + "/oauth2/token", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: body
    });

    if (!res.ok) {
        document.body.innerHTML = "<p>トークン交換エラー: " + res.status + "</p>";
        return;
    }

    const data = await res.json();

    // ★ ID_TOKEN を Cookie に保存（CloudFront 認証判定用）
    document.cookie = `idToken=${data.id_token}; path=/; secure; SameSite=Lax`;

    // PKCE 用データ消去
    localStorage.removeItem("pkce_verifier");

    // メインページへリダイレクト
    window.location.href = "/index.html";
}

function main() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
        document.body.innerHTML = "<p>code がありません</p>";
        return;
    }

    exchangeToken(code);
}

main();
</script>

</body>
</html>
